<script language="javascript" type="text/javascript">
//Category Page Color Swatches and Size Options
$('<style type="text/css">\
		/* Color and Size Options on Category Pages */\
		/*.catSizeSwatch {\
			display: none;\
		}*/\
		.catColorSwatch {\
			display: inline-block;\
		}\
		.catColorSwatch li {\
			padding: 0 4px;\
		}\
		.catColorSwatch ul {\
			margin: 0 auto;\
		}\
		.catColorSwatch .swatchOneColour .validation,\
		.catColorSwatch .swatchOneColour .name,\
		.catColorSwatch .swatchTexture .name,\
		.catSizeSwatch .validation/*,\
		.catSizeSwatch .name*/ {\
			display: none;\
		}\
		.catColorSwatch li .validation {\
			display: none;\
		}\
		.catColorSwatch li,\
		.catColorSwatch li.swatch.swatchTexture,\
		.catColorSwatch li.swatch.swatchOneColour {\
			display: inline-block;\
			float: left;\
			width: auto !important;\
			padding: 0;\
			padding: 5px 4px 1px;\
			margin-bottom: 0;\
		}\
		.catColorSwatch li.swatch.swatchOneColour.selectedColorBox {\
			padding: 0;\
		}\
		.catColorSwatch li label {\
			margin: 0;\
			line-height: normal;\
			border: 3px solid #d5d5d5;\
			border-radius: 4px;\
		}\
		.catColorSwatch li.hovered label {\
			border-color: #666;\
		}\
		.catColorSwatch li.selected label {\
			border-color: #39b54a;\
		}\
		.catColorSwatch li.swatch.swatchOneColour label span.swatchColours.swatchOneColour {\
			line-height: inherit;\
		}\
		.catColorSwatch .swatchColour {\
			display: inline-block;\
			width: 17px !important;\
			height: 17px !important;\
			border: 1px solid #fff;\
			border-radius: 4px;\
		}\
		.catColorSwatch .name {\
			line-height: 19px;\
			padding: 0 4px;\
		}\
		.catSizeSwatch {\
			background-size: auto 100%;\
			position: absolute;\
			top: 200px;\
			right: 0px;\
			padding: 3px 0;\
			width: 45px;\
		}\
        #SearchProduct_Container .catSizeSwatch {\
            top: 120px;\
        }\
		.catSizeSwatch .list-horizontal {\
			margin: 0;\
		}\
		.catSizeSwatch .list-horizontal .option {\
			display: inline-block;\
			width: 37px !important;\
			padding: 0;\
			background: none;\
            margin: 2px;\
		}\
		.catSizeSwatch .list-horizontal .option label {\
			margin: 0;\
		}\
		.catSizeSwatch .list-horizontal .option label .name {\
		    font-weight: bold;\
		    color: black;\
		    display: block;\
		    font-size: 8px;\
		    line-height: 8px;\
		}\
		.sizeOptionsOverlay {\
			/* background: url("%%ASSET_images/JointSizesL.png%%") center center no-repeat; */\
			background-size: auto 100%;\
			position: absolute;\
			top: 253px;\
			right: 0px;\
			padding: 3px 0;\
			width: 45px;\
		}\
		.catSizeSwatch .jointTitle,\
		.sizeOptionsOverlay .jointTitle {\
		    font-weight: bold;\
			display: inline-block;\
		    line-height: 9px;\
		    font-size: 8px;\
		}\
		.sizeOptionsOverlay .jointSize {\
		    display: inline-block;\
		    text-align: center;\
		    color: #BBB;\
		    vertical-align: bottom;\
		}\
		.catSizeSwatch img,\
		.sizeOptionsOverlay .jointSize img {\
		    width: 14px;\
		    display: block;\
		    margin: 0 auto;\
		}\
		.sizeOptionsOverlay .jointSize span {\
		    font-weight: bold;\
		    color: black;\
		    display: block;\
		    font-size: 8px;\
		}\
		.sizeOptionsOverlay .jointSize i {\
		    display: block;\
		}\
		.catSizeSwatch img.small,\
		.sizeOptionsOverlay .jointSize.small img {\
		    width: 10px;\
		}\
		.catSizeSwatch img.big,\
		.sizeOptionsOverlay .jointSize.big img {\
		    width: 18px;\
		}\
		.catColorSwatch .textureContainer {\
			display: block;\
			width: 20px;\
		}\
		.catColorSwatch .textureContainer .thumbnail,\
		.catColorSwatch .productOptionPickListSwatch .thumbnail {\
			display: block;\
			background-size: 100%;\
			border: 1px solid white;\
			height: 17px;\
		}\
		.ProductList .ProductImage img.colorSwatchImage {\
			width:auto;\
			max-height: 400px;\
		}\
		@media screen and (device-aspect-ratio: 40/71) {\
			.catSizeSwatch {\
				top: 170px;\
			}\
		}\
		</style>')
    .appendTo('head');

jQuery.expr[':'].icontains = function(a, i, m) {
  return jQuery(a).text().toUpperCase()
      .indexOf(m[3].toUpperCase()) >= 0;
};   

/* try to combine this with category videos! */
function loadColorAndSizeSwatches() {
    // Swatches - Color and Size options swatches 
    $(".ProductActionAdd a:contains('Options')").each(function checkForOptionSwatches(url) {
        var productListing = $(this).closest('em.p-price').html();
        var productLink = $(this).parent().parent().find('div.ProductImage a').attr('href');
        var $this = $(this);

        function getOptionSwatches() {
            return $.ajax({
                url: productLink,
                type: 'GET',
                dataType: 'html',
            });
        }
        getOptionSwatches()
            .done(function(data) {

                result = data;
                var productPage = result;
                var $productPageProcessing = $(productPage).find('.productAttributeList');
                var jointSizeAndGender = $(productPage).find('.JointSizeHeightContainer .Label:icontains("Joint Type:")').parent().find('.Value').text();
                var maleOrFemale = $.trim(jointSizeAndGender).split(' ')[1];
				var colorSwatch = $productPageProcessing.find("span:icontains('Color')").parents().eq(2).find('.productAttributeValue div').html();
				var colorSwatchContent = $('<div class="catColorSwatch optionSwatch">' + colorSwatch + '</div>').fadeIn('slow').css("display","inline-block");
                var sizeSwatch = $productPageProcessing.find("span:icontains('Size')").parents().eq(2).find('.productAttributeValue div').html();
                var sizeOptionsOverlay = $('<div class="catSizeSwatch optionSwatch"><span class="jointTitle">Fits these joint sizes:</span>' + 
                						sizeSwatch + '</div>').fadeIn(1300);
                if (colorSwatch != null) {
                    $this.parent().parent().find('.ProductDetails').before(colorSwatchContent);
                    $this.addClass('withColorSwatch');
                    // Color swatch clickability Starts here
                    $(".withColorSwatch").each(function() {
                        var productDiv = $(this).parent().parent();
                        var productColorSwatch = productDiv.find('.catColorSwatch');
    					//productColorSwatch.find('li.swatch').attr({style: 'width: auto !important;'});

                        var productName = productDiv.find('.pname').text();
                        var images = [];
                        var productNumber = productDiv.find('.ProductCompareButton .CheckBox').attr('value');

                        // We can pull the color values from the DOM! :)
                        var colors = [];
                        productColorSwatch.find("input.validation").each(function() {
                            colors.push({
                                value: $(this).val(),
                                name: $(this).parent().find("span.swatchColours").attr("title"),
                                url: ''
                            });
                        });

                        var queue = Array.prototype.concat.call(colors); // Make a copy of the array
                        function poll(cb) {
                            // Is queue finished ?
                            if (!queue.length) {
                                cb();
                                return;
                            }

                            // Next color in queue
                            var color = queue.pop();
                            var attributeValue = productColorSwatch.find('.validation').attr('name').replace(/\D/g, '');
                            var args = {
                                action: "add",
                                w: "getProductAttributeDetails",
                                product_id: productNumber,
                                attribute: []
                            };
                            args.attribute[attributeValue] = color.value;

                            $.post("/remote.php", args, function(response) {
                                if (response && response.details && response.details.image) {
                                    result[color.name] = response.details.image;
                                    color.url = response.details.image;
                                }
                                poll(cb); // Next in queue
                            });

                            var productImage = productDiv.find('.ProductImage a img');
                            productImage.addClass('colorSwatchImage');
                            var colorSwatchBox = productColorSwatch.find('.validation[value=' + color.value + ']').parent().parent();
                            var activeImage = productImage.attr('src');
                            productImage.attr('data-original', activeImage);
                            var originalImage = productImage.attr('data-original');
                            colorSwatchBox.on({
                                mouseenter: function(event) {
                                    originalImage = $(this).parents().eq(2).find('.ProductImage a img').attr('data-original');
                                    $(this).parents().eq(2).find('.ProductImage a img').attr('src', color.url);
                                    $(this).addClass('hovered');
                                },
                                mouseleave: function(event) {
                                    $(this).removeClass('hovered');
                                    if (!$(this).hasClass('selected')) {
										$(this).delay(10).parents().eq(2).find('.ProductImage a img').attr('src', originalImage);
                                    }
                                    //$(this).parents().eq(2).find('.ProductImage a img').attr('src', originalImage);
                                },
                                click: function(event) {
                                    $(this).parent().find('li').removeClass('selected');
                                    $(this).addClass('selected');
                                    $(this).parents().eq(2).find('.ProductImage a img').attr('src', color.url);
                                    $(this).parents().eq(2).find('.ProductImage a img').attr('data-original', color.url);
                                }
                            });
                        }

                        poll(function() {
                            return;
                        });

                    });
                    // Color swatch clickability ends here
                };
                if (sizeSwatch != null) {
                    var thisProductListing = $this.parent().parent();
                    if (maleOrFemale == 'Female') {
                        thisProductListing.find('.ProductDetails').before(sizeOptionsOverlay);
                        thisProductListing.find('.name:icontains("10mm")').text('Male 10mm').after('<img class="small" src="%%ASSET_images/malejoint.png%%" />');
                        thisProductListing.find('.name:icontains("14mm")').text('Male 14mm').after('<img src="%%ASSET_images/malejoint.png%%" />');
                        thisProductListing.find('.name:icontains("18mm")').text('Male 18mm').after('<img class="big" src="%%ASSET_images/malejoint.png%%" />');
                    };
                    if (maleOrFemale == 'Male') {
                        thisProductListing.find('.ProductDetails').before(sizeOptionsOverlay);
                        thisProductListing.find('.name:icontains("10mm")').text('Female 10mm').after('<img class="small" src="%%ASSET_images/femalejoint.png%%" />');
                        thisProductListing.find('.name:icontains("14mm")').text('Female 14mm').after('<img src="%%ASSET_images/femalejoint.png%%" />');
                        thisProductListing.find('.name:icontains("18mm")').text('Female 18mm').after('<img class="big" src="%%ASSET_images/femalejoint.png%%" />');
                    };
                };
            }).fail(function() {
                return;
            });
    });
};

$(document).ready(function() {
    loadColorAndSizeSwatches();
});
</script>